<svg width="900" height="900" viewBox="0 0 900 800" xmlns="http://www.w3.org/2000/svg">
<style>
  .box { fill:#e8f0ff; stroke:#003366; stroke-width:2; rx:12; }
  .startend { fill:#ffecec; stroke:#990000; stroke-width:2; rx:40; }
  .decision { fill:#fff8d6; stroke:#b38f00; stroke-width:2; }
  .arrow { stroke:#000; stroke-width:2; marker-end:url(#arrowhead); }
  text { font-family:Arial, sans-serif; font-size:16px; }
</style>
<defs>
  <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
    <polygon points="0 0, 10 3.5, 0 7" fill="#000"/>
  </marker>
</defs>

<!-- Start -->
<rect class="startend" x="310" y="20" width="280" height="60"/>
<text x="450" y="52" text-anchor="middle">Start: robust_df_over_f_1d</text>

<!-- Inputs -->
<rect class="box" x="250" y="100" width="400" height="70"/>
<text x="450" y="130" text-anchor="middle">
Inputs: F (1D), win_sec, perc, fps
</text>
<text x="450" y="155" text-anchor="middle">
Convert F → float32, n = len(F)
</text>

<!-- Handle non-finite -->
<rect class="box" x="250" y="200" width="400" height="80"/>
<text x="450" y="235" text-anchor="middle">
Check finite values in F
</text>
<text x="450" y="260" text-anchor="middle">
If any non-finite: interpolate over gaps
</text>

<!-- Window computation -->
<rect class="box" x="250" y="310" width="400" height="90"/>
<text x="450" y="340" text-anchor="middle">
Compute window:
</text>
<text x="450" y="365" text-anchor="middle">
win = max(3, int(win_sec·fps) forced odd)
</text>
<text x="450" y="390" text-anchor="middle">
Clamp win ≤ n (odd)
</text>

<!-- Decision: win < 3? -->
<polygon class="decision" points="450,430 560,480 450,530 340,480"/>
<text x="450" y="480" text-anchor="middle">
Is win &lt; 3?
</text>

<!-- Branch YES: fallback baseline -->
<rect class="box" x="70" y="560" width="320" height="80"/>
<text x="230" y="595" text-anchor="middle">
Fallback baseline:
</text>
<text x="230" y="620" text-anchor="middle">
F₀ = constant = percentile(F, perc)
</text>

<!-- Branch NO: percentile filter -->
<rect class="box" x="510" y="560" width="320" height="80"/>
<text x="670" y="595" text-anchor="middle">
Rolling baseline:
</text>
<text x="670" y="620" text-anchor="middle">
F₀ = percentile_filter(F, perc, win)
</text>

<!-- Epsilon and dF/F -->
<rect class="box" x="250" y="670" width="400" height="90"/>
<text x="450" y="705" text-anchor="middle">
eps = max(percentile(F₀, 1), 1e−9)
</text>
<text x="450" y="735" text-anchor="middle">
dff = (F − F₀) / eps
</text>

<!-- End -->
<rect class="startend" x="310" y="780" width="280" height="50"/>
<text x="450" y="812" text-anchor="middle">Return dff (ΔF/F)</text>

<!-- Arrows -->
<line class="arrow" x1="450" y1="70" x2="450" y2="100"/>
<line class="arrow" x1="450" y1="170" x2="450" y2="200"/>
<line class="arrow" x1="450" y1="280" x2="450" y2="310"/>
<line class="arrow" x1="450" y1="400" x2="450" y2="430"/>

<!-- Decision YES arrow -->
<line class="arrow" x1="400" y1="530" x2="230" y2="560"/>

<!-- Decision NO arrow -->
<line class="arrow" x1="500" y1="530" x2="670" y2="560"/>

<!-- Merge from branches to eps/dff -->
<line class="arrow" x1="230" y1="640" x2="450" y2="670"/>
<line class="arrow" x1="670" y1="640" x2="450" y2="670"/>

<line class="arrow" x1="450" y1="760" x2="450" y2="780"/>

</svg>
